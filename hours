#!/usr/bin/env python

import sys
import requests
from requests.auth import HTTPBasicAuth
import subprocess
import datetime
import decimal
from bs4 import BeautifulSoup
import argparse
from prettytable import PrettyTable 
from prettytable import * 


def main():

  parser = argparse.ArgumentParser()
  subparsers = parser.add_subparsers()
  parser.set_defaults(view='time')

  parser_view = subparsers.add_parser('view')
  parser_view.add_argument('time', choices=['day', 'week', 'yesterday', ], default='day', nargs='?')

  args = parser.parse_args()
  if args.time == 'day':
    listToday()

  elif args.time == 'yesterday':
    listYesterday()

  elif args.time == 'week':
    listWeek()
  

def listYesterday():
  today = datetime.date.today()
  yesterday = today - datetime.timedelta(1)

  breakdown = basecamp.hoursByDay(yesterday)
  print "Hour breakdown for yesterday"
  printBreakdown(breakdown)

def listToday():
  #total = basecamp.hoursToday()
  #print str(total) + " hours logged in basecamp today"
  breakdown = basecamp.hoursToday()
  print "Hour breakdown for today"
  printBreakdown(breakdown)



def listWeek():
  breakdown = basecamp.hoursWeek()
  print "Hour breakdown for the week"
  printBreakdown(breakdown)

def printBreakdown(breakdown):
  total = 0
  table = PrettyTable(["-", "-", "-"],hrules=FRAME)
  table.align = "l"
  table.set_style(PLAIN_COLUMNS)
  table.add_row(["Client", "Project", "Hours"])
  table.add_row(["-","-","-"])
  for key, value in breakdown.iteritems():
    info = basecamp.getProjectInfo(key)
    table.add_row([info['client'], info['name'], value])
    total += value

  table.add_row(["-","-","-"])
  table.add_row(["","Total",total])
  print table



class Basecamp:
  def __init__(self):
    # get the config from git
    self.bcUser = subprocess.check_output("git config basecamp.user-id", shell=True).strip()
    self.bcKey = subprocess.check_output("git config basecamp.key", shell=True).strip()
    self.bcUrl = subprocess.check_output("git config basecamp.url", shell=True).strip()
    self.auth = HTTPBasicAuth(self.bcKey, '')
    self.projects = {}


  # returns beautifulsoup object of the time report
  def getReport(self, fromDate, toDate):
    r = requests.get(self.bcUrl + "/time_entries/report.xml?subject_id=" + self.bcUser + "&from=" + fromDate + "&to=" + toDate, auth=self.auth)
    return BeautifulSoup(r.text)



  def getProjectInfo(self, project_id):
    if project_id in self.projects:
      return self.projects[project_id]
    
    r = requests.get(self.bcUrl + "/projects/" + project_id + ".xml", auth=self.auth)
    xml = BeautifulSoup(r.text)
    p = {"name":xml.find("name").string, "client":xml.find("company").find("name").string}

    self.projects[project_id] = p
    return p
  
  def hoursRange(self, start, end):
    start = start.strftime("%Y%m%d")
    end = end.strftime("%Y%m%d")

    entries = self.getReport(start, end)
    projects = {}
    total = 0

    for entry in entries.findAll('time-entry'):
      time = float(entry.find('hours').string)
      total += time

      pid = entry.find('project-id').string

      if pid in projects:
        projects[pid] += time
      else:
        projects[pid] = time

    return projects

  def hoursByDay(self, date):
    return self.hoursRange(date, date)  

  def hoursToday(self):
    now = datetime.datetime.now()
   
    return self.hoursByDay(now)


  def hoursWeek(self):
    now = datetime.datetime.now()
    monday = now - datetime.timedelta(now.weekday())

    return self.hoursRange(monday, now)


basecamp = Basecamp()



if __name__ == '__main__':
  main()
